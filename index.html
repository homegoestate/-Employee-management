<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>HomeGo Estate - é›²ç«¯ä¸­æ§ç³»çµ±</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        /* === æ¨£å¼è¨­å®š (ä¿æŒä¸è®Š) === */
        :root {
            --primary-color: #2c3e50;
            --secondary-color: #34495e;
            --accent-color: #3498db;
            --text-light: #ecf0f1;
            --danger-color: #e74c3c;
            --sidebar-width: 250px;
        }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; margin: 0; padding: 0; background-color: #f4f4f4; height: 100vh; overflow: hidden; user-select: none; }
        
        .auth-container { display: flex; justify-content: center; align-items: center; height: 100vh; background: linear-gradient(135deg, var(--primary-color), var(--secondary-color)); padding: 20px; }
        .auth-box { background: white; padding: 30px; border-radius: 10px; box-shadow: 0 10px 25px rgba(0,0,0,0.5); width: 100%; max-width: 400px; text-align: center; }
        .auth-box h2 { color: var(--primary-color); margin-bottom: 20px; }
        
        .input-group { margin: 15px 0; text-align: left; }
        .input-group label { font-size: 13px; color: #555; font-weight: bold; display: block; margin-bottom: 5px;}
        .auth-box input[type="text"], 
        .auth-box input[type="password"],
        .auth-box input[type="number"] { 
            width: 100%; padding: 12px; border: 1px solid #ccc; border-radius: 5px; box-sizing: border-box; font-size: 16px; 
        }

        .checkbox-group { display: flex; align-items: center; justify-content: flex-start; margin: 15px 0; gap: 8px; }
        .checkbox-group input[type="checkbox"] { width: 20px; height: 20px; margin: 0; cursor: pointer; }
        .checkbox-group label { font-size: 15px; color: #333; cursor: pointer; margin: 0; }

        .btn { width: 100%; padding: 12px; border: none; border-radius: 5px; cursor: pointer; font-size: 16px; margin-top: 15px; font-weight: bold; color: white; transition: 0.3s; }
        .btn-primary { background-color: var(--accent-color); }
        .btn-secondary { background-color: #95a5a6; }
        .btn-danger { background-color: var(--danger-color); }
        .switch-link { margin-top: 20px; font-size: 14px; color: #7f8c8d; cursor: pointer; text-decoration: underline; }
        .alert-box { background-color: #e8f4f8; color: #2c3e50; padding: 12px; border-radius: 5px; font-size: 13px; margin-bottom: 15px; border-left: 4px solid var(--accent-color); text-align: left; }
        
        #dashboard-section { display: none; height: 100vh; position: relative; overflow: hidden; }
        .menu-toggle-btn { display: none; position: absolute; top: 15px; left: 15px; z-index: 2000; background: var(--primary-color); color: white; border: none; padding: 10px 15px; border-radius: 5px; cursor: pointer; }
        .sidebar { width: var(--sidebar-width); background-color: var(--primary-color); color: var(--text-light); display: flex; flex-direction: column; z-index: 1500; transition: transform 0.3s ease; }
        .sidebar-header { padding: 20px; text-align: center; background-color: var(--secondary-color); font-weight: bold; }
        .nav-links { list-style: none; padding: 0; margin: 0; flex-grow: 1; overflow-y: auto; }
        .nav-links li { border-bottom: 1px solid rgba(255,255,255,0.1); }
        .nav-links li a { display: block; padding: 15px 20px; color: var(--text-light); text-decoration: none; }
        .nav-links li a:hover, .nav-links li a.active { background-color: var(--accent-color); }
        .user-info { padding: 15px; background-color: var(--secondary-color); text-align: center; font-size: 0.9em; }
        .main-content { flex-grow: 1; background-color: white; position: relative; width: 100%; }
        iframe { width: 100%; height: 100%; border: none; }

        @media (max-width: 768px) {
            .menu-toggle-btn { display: block; }
            .sidebar { position: absolute; height: 100%; left: 0; top: 0; transform: translateX(-100%); }
            .sidebar.active { transform: translateX(0); }
            .sidebar-overlay { display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 1400; }
            .sidebar-overlay.active { display: block; }
        }

        #admin-panel { display: none; padding: 20px; background: white; height: 100%; overflow-y: auto; }
        .table-responsive { overflow-x: auto; }
        table { width: 100%; border-collapse: collapse; margin-top: 10px; min-width: 500px; }
        th, td { border: 1px solid #ddd; padding: 10px; text-align: left; }
        th { background-color: var(--primary-color); color: white; }
        .device-badge { padding: 3px 8px; border-radius: 12px; font-size: 12px; color: white; }
        .bg-desktop { background-color: #3498db; }
        .bg-mobile { background-color: #e67e22; }
        .bg-tablet { background-color: #9b59b6; }
        .admin-section { border: 1px solid #ddd; padding: 20px; border-radius: 8px; margin-bottom: 20px; background: #fdfdfd; }
        .code-display { font-size: 20px; font-weight: bold; color: var(--danger-color); background: #eee; padding: 10px; display: inline-block; letter-spacing: 2px; }
        #loading-overlay { position: fixed; top:0; left:0; width:100%; height:100%; background:rgba(255,255,255,0.8); z-index: 9999; display:flex; justify-content:center; align-items:center; color: var(--primary-color); font-weight:bold; }
    </style>
</head>
<body>

    <div id="loading-overlay" style="display:none;">é€£ç·šé›²ç«¯è³‡æ–™åº«ä¸­...</div>

    <div id="auth-section" class="auth-container">
        <div id="login-form" class="auth-box">
            <h2>ğŸ” å“¡å·¥å®‰å…¨ç™»å…¥ (é›²ç«¯ç‰ˆ)</h2>
            <div class="alert-box">æœ¬ç³»çµ±å·²é€£ç·šè‡³é›²ç«¯è³‡æ–™åº«ã€‚</div>
            <div class="input-group">
                <label>ä½¿ç”¨è€…åç¨±</label>
                <input type="text" id="login-user" placeholder="è¼¸å…¥å¸³è™Ÿ" autocomplete="username">
            </div>
            <div class="input-group">
                <label>å¯†ç¢¼</label>
                <input type="password" id="login-pass" placeholder="è¼¸å…¥å¯†ç¢¼" autocomplete="current-password">
            </div>
            
            <div class="checkbox-group">
                <input type="checkbox" id="keep-login"> 
                <label for="keep-login">ä¿æŒç™»å…¥</label>
            </div>

            <button id="btnLogin" class="btn btn-primary">ç™»å…¥</button>
            <div class="switch-link" onclick="showRegister()">æ–°å“¡å·¥ï¼Ÿè¨»å†Šä¸¦ç¶å®šæ­¤è£ç½®</div>
            <div class="switch-link" onclick="showAdminAuth()">ç®¡ç†å“¡å¾Œå°</div>
        </div>

        <div id="register-form" class="auth-box" style="display: none;">
            <h2>ğŸ“± è¨»å†Šä¸¦ç¶å®šè£ç½®</h2>
            <div class="alert-box">è«‹è¼¸å…¥ç®¡ç†å“¡æä¾›çš„é–‹é€šç¢¼ã€‚<br>(ç¶å®šæ–°è£ç½®æ™‚ï¼Œè«‹è¼¸å…¥åŸå¯†ç¢¼)</div>
            <div class="input-group"><input type="text" id="reg-user" placeholder="è¨­å®šä½¿ç”¨è€…åç¨±" autocomplete="username"></div>
            <div class="input-group"><input type="password" id="reg-pass" placeholder="è¼¸å…¥æ‚¨çš„ç™»å…¥å¯†ç¢¼" autocomplete="new-password"></div>
            <div class="input-group">
                <label style="color:var(--danger-color);">è£ç½®é–‹é€šç¢¼</label>
                <input type="number" id="reg-code" placeholder="è«‹è¼¸å…¥6ä½æ•¸ä»£ç¢¼">
            </div>
            <button id="btnRegister" class="btn btn-secondary">é©—è­‰ç¶å®šä¸¦è¨»å†Š</button>
            <div class="switch-link" onclick="showLogin()">è¿”å›</div>
        </div>

        <div id="admin-auth-form" class="auth-box" style="display: none;">
            <h2>ç®¡ç†å“¡é©—è­‰</h2>
            <input type="password" id="admin-pass-input" placeholder="ç®¡ç†å“¡å¯†ç¢¼">
            <button id="btnAdminLogin" class="btn btn-danger">é€²å…¥å¾Œå°</button>
            <div class="switch-link" onclick="showLogin()">è¿”å›</div>
        </div>
    </div>

    <div id="dashboard-section">
        <button class="menu-toggle-btn" onclick="toggleSidebar()"><i class="fas fa-bars"></i> é¸å–®</button>
        <div class="sidebar-overlay" onclick="toggleSidebar()"></div>

        <div class="sidebar" id="sidebar">
            <div class="sidebar-header">HomeGo Estate</div>
            <ul class="nav-links">
                <li><a href="#" onclick="loadPage(0, this)" class="active">å“¡å·¥ç®¡ç†</a></li>
                <li><a href="#" onclick="loadPage(1, this)">æ¡ˆä»¶ç®¡ç†</a></li>
                <li><a href="#" onclick="loadPage(2, this)">æ”¶æ“šç³»çµ±</a></li>
                <li><a href="#" onclick="loadPage(3, this)">å ±åƒ¹ç³»çµ±</a></li>
                <li><a href="#" onclick="loadPage(4, this)">AI å•ç­”åŠ©æ‰‹</a></li>
                <li><a href="#" onclick="loadPage(5, this)">éŠ€è¡Œå„ªé¸</a></li>
                
                <li id="admin-link" style="display:none;"><a href="#" onclick="showAdminPanel(this)" style="background:#c0392b;">ç®¡ç†å“¡å¾Œå°</a></li>
            </ul>
            <div class="user-info">
                æ­¡è¿, <span id="display-username">User</span><br>
                <button class="btn btn-danger" style="padding:5px; margin-top:10px; font-size:12px;" onclick="window.logout()">ç™»å‡º</button>
            </div>
        </div>

        <div class="main-content">
            <iframe id="content-frame" src=""></iframe>
            <div id="admin-panel">
                <h2 style="padding-top:40px;">ğŸ” é›²ç«¯ç®¡ç†å“¡æ§åˆ¶å°</h2>
                
                <div class="admin-section" style="border-left: 5px solid var(--danger-color);">
                    <h3>ğŸš« é›¢è·é»‘åå–®ç‹€æ…‹</h3>
                    <p>è«‹ä¿®æ”¹ç¨‹å¼ç¢¼ä¸­çš„ <code>BANNED_USERS</code> ä¾†å°é–ã€‚</p>
                    <div id="banned-list-display" style="color:red; font-weight:bold;">ç›®å‰å°é–åå–®ï¼šç„¡</div>
                </div>

                <div class="admin-section">
                    <h3>ğŸš€ é–‹é€šç¢¼ç”¢ç”Ÿå™¨</h3>
                    <div style="display:flex; gap:10px;">
                        <input type="text" id="admin-generate-name" placeholder="å“¡å·¥å¸³è™Ÿ" style="padding:10px; flex:1;">
                        <button class="btn btn-danger" style="width:auto; margin:0;" onclick="generateCode()">ç”¢ç”Ÿ</button>
                    </div>
                    <div id="generated-code-area" style="display:none; margin-top:10px;">é–‹é€šç¢¼ï¼š<span id="display-code" class="code-display"></span></div>
                </div>

                <div class="admin-section">
                    <h3>ğŸ‘¥ é›²ç«¯ä½¿ç”¨è€…åˆ—è¡¨ (å³æ™‚åŒæ­¥)</h3>
                    <div class="table-responsive">
                        <table id="user-table">
                            <thead><tr><th>ä½¿ç”¨è€…</th><th>æœ€æ–°ç™»å…¥è£ç½®</th><th>æˆæ¬Šè£ç½®æ•¸</th><th>æ“ä½œ</th></tr></thead>
                            <tbody id="user-table-body"></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAnalytics } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-analytics.js";
        import { getDatabase, ref, set, get, child, update, remove, onValue } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

        // === æ‚¨çš„ Firebase è¨­å®š ===
        const firebaseConfig = {
            apiKey: "AIzaSyCSOS-36oQ6hTyhtD2vrez3QGvPdvwMOIw",
            authDomain: "mainmanagement-1f3d2.firebaseapp.com",
            databaseURL: "https://mainmanagement-1f3d2-default-rtdb.firebaseio.com",
            projectId: "mainmanagement-1f3d2",
            storageBucket: "mainmanagement-1f3d2.firebasestorage.app",
            messagingSenderId: "916729301354",
            appId: "1:916729301354:web:11d81d965c2127b0a17d13",
            measurementId: "G-NQ6YKGEJE9"
        };

        const app = initializeApp(firebaseConfig);
        const analytics = getAnalytics(app);
        const db = getDatabase(app);

        // === å…¨åŸŸè¨­å®š ===
        const ADMIN_PASS = "8888";
        const SECRET_SALT = 9527; 
        const BANNED_USERS = []; 
        
        // MODIFIED: Removed the "case-procedure" URL from this array
        const SITES = [
            "https://homegoestate.github.io/-Employee-management/", // Index 0
            "https://homegoestate.github.io/case/",                // Index 1
            // Removed: case-procedure
            "https://homegoestate.github.io/receipts/",            // Index 2 (Shifted up)
            "https://homegoestate.github.io/quotation/",           // Index 3
            "https://homegoestate.github.io/AI-question-assistant/", // Index 4
            "https://homegoestate.github.io/Bank-choice/"          // Index 5
        ];

        // === è£ç½®æŒ‡ç´‹è­˜åˆ¥ (Device ID) ===
        let myDeviceId = localStorage.getItem('hg_cloud_did');
        if (!myDeviceId) {
            myDeviceId = 'DID-' + Math.random().toString(36).substr(2, 9).toUpperCase();
            localStorage.setItem('hg_cloud_did', myDeviceId);
        }

        // === å·¥å…·å‡½å¼ ===
        function showLoading(show) {
            document.getElementById('loading-overlay').style.display = show ? 'flex' : 'none';
        }

        function getDeviceType() {
            const ua = navigator.userAgent;
            if (/(tablet|ipad|playbook|silk)|(android(?!.*mobi))/i.test(ua)) return "tablet";
            if (/Mobile|Android|iP(hone|od)|IEMobile/.test(ua)) return "mobile";
            return "desktop";
        }

        function getDeviceLabel(type) {
            if(type === 'mobile') return '<span class="device-badge bg-mobile"><i class="fas fa-mobile-alt"></i> æ‰‹æ©Ÿ</span>';
            if(type === 'tablet') return '<span class="device-badge bg-tablet"><i class="fas fa-tablet-alt"></i> å¹³æ¿</span>';
            return '<span class="device-badge bg-desktop"><i class="fas fa-desktop"></i> é›»è…¦</span>';
        }

        window.calculateActivationCode = (username) => {
            let hash = 0, name = username.trim();
            for (let i = 0; i < name.length; i++) hash = name.charCodeAt(i) + ((hash << 5) - hash);
            return (Math.abs(hash * SECRET_SALT) % 1000000).toString().padStart(6, '0');
        }

        // === UI åˆ‡æ› ===
        window.showRegister = () => {
            document.getElementById('login-form').style.display = 'none';
            document.getElementById('register-form').style.display = 'block';
        }
        window.showLogin = () => {
            document.getElementById('register-form').style.display = 'none';
            document.getElementById('admin-auth-form').style.display = 'none';
            document.getElementById('login-form').style.display = 'block';
        }
        window.showAdminAuth = () => {
            document.getElementById('login-form').style.display = 'none';
            document.getElementById('admin-auth-form').style.display = 'block';
        }

        // === è¨»å†Šèˆ‡ç¶å®šæµç¨‹ (ä¿®æ­£ç‰ˆï¼šé˜²æ­¢å¯†ç¢¼è¦†è“‹) ===
        document.getElementById('btnRegister').addEventListener('click', async () => {
            const user = document.getElementById('reg-user').value.trim();
            const pass = document.getElementById('reg-pass').value.trim();
            const inputCode = document.getElementById('reg-code').value.trim();

            if(BANNED_USERS.includes(user)) return alert("æ­¤å¸³è™Ÿå·²è¢«å…¬å¸åœç”¨ã€‚");
            if(!user || !pass || !inputCode) return alert("è«‹è¼¸å…¥å®Œæ•´è³‡è¨Š");
            if (inputCode !== window.calculateActivationCode(user)) return alert("âŒ é–‹é€šç¢¼éŒ¯èª¤ï¼Œè«‹æ´½ç®¡ç†å“¡ã€‚");

            showLoading(true);
            try {
                const userRef = ref(db, 'users/' + user);
                const snapshot = await get(userRef);
                const deviceType = getDeviceType();

                if (snapshot.exists()) {
                    // å¸³è™Ÿå·²å­˜åœ¨ï¼Œæº–å‚™ç¶å®šæ–°è£ç½®
                    const userData = snapshot.val();
                    
                    // ã€é—œéµä¿®æ­£ã€‘æª¢æŸ¥å¯†ç¢¼æ˜¯å¦ä¸€è‡´ï¼Œé˜²æ­¢èª¤è“‹
                    if (userData.password !== pass) {
                        showLoading(false);
                        alert("âš ï¸ å¸³è™Ÿå·²å­˜åœ¨ï¼Œä½†æ‚¨è¼¸å…¥çš„å¯†ç¢¼èˆ‡åŸå¯†ç¢¼ä¸ç¬¦ï¼\n\nç‚ºä¿è­·æ‚¨çš„å¸³è™Ÿå®‰å…¨ï¼Œè«‹è¼¸å…¥åŸæœ¬è¨­å®šçš„å¯†ç¢¼ä¾†ç¶å®šæ­¤è£ç½®ã€‚");
                        return;
                    }

                    let devices = userData.authorizedDevices || [];
                    
                    if(!devices.includes(myDeviceId)) {
                        if(!confirm("å¸³è™Ÿé©—è­‰æˆåŠŸï¼è¦å°‡æ­¤æ–°è£ç½®åŠ å…¥æˆæ¬Šåå–®å—ï¼Ÿ")) {
                            showLoading(false); return;
                        }
                        devices.push(myDeviceId);
                        // é€™è£¡ä¸æ›´æ–° passwordï¼Œåªæ›´æ–°è£ç½®åˆ—è¡¨ï¼Œç¢ºä¿å¯†ç¢¼ä¸€è‡´
                        await update(userRef, { 
                            authorizedDevices: devices,
                            lastDeviceType: deviceType 
                        });
                        alert("âœ… æ–°è£ç½®ç¶å®šæˆåŠŸï¼æ‚¨ç¾åœ¨å¯ä»¥ä½¿ç”¨æ­¤è£ç½®ç™»å…¥äº†ã€‚");
                    } else {
                        alert("âš ï¸ æ­¤è£ç½®å·²ç¶“ç¶å®šéäº†ï¼Œè«‹ç›´æ¥ç™»å…¥ã€‚");
                    }
                } else {
                    // æ–°å¸³è™Ÿå»ºç«‹ (ç¬¬ä¸€æ¬¡è¨»å†Š)
                    await set(userRef, {
                        password: pass,
                        lastDeviceType: deviceType,
                        authorizedDevices: [myDeviceId]
                    });
                    alert("âœ… è¨»å†Šä¸¦ç¶å®šæˆåŠŸï¼");
                }
                window.showLogin();
            } catch (error) {
                console.error(error);
                alert("é€£ç·šéŒ¯èª¤ï¼š" + error.message);
            }
            showLoading(false);
        });

        // === ç™»å…¥æµç¨‹ (å«è£ç½®ç‹€æ…‹æ›´æ–°) ===
        document.getElementById('btnLogin').addEventListener('click', async (e) => {
            e.preventDefault();
            const user = document.getElementById('login-user').value.trim();
            const pass = document.getElementById('login-pass').value.trim();
            const keep = document.getElementById('keep-login').checked;

            if (BANNED_USERS.includes(user)) return alert("æ‚¨çš„å¸³è™Ÿå·²è¢«å…¬å¸åœç”¨ã€‚");
            if (!user || !pass) return alert("è«‹è¼¸å…¥å¸³è™Ÿå¯†ç¢¼");

            showLoading(true);
            try {
                const snapshot = await get(ref(db, 'users/' + user));
                if (snapshot.exists()) {
                    const data = snapshot.val();
                    if (data.password === pass) {
                        const devices = data.authorizedDevices || [];
                        if (devices.includes(myDeviceId)) {
                            if(keep) localStorage.setItem('hg_cloud_session', user);
                            
                            // æ›´æ–°æœ€å¾Œç™»å…¥è£ç½®
                            const currentDeviceType = getDeviceType();
                            await update(ref(db, 'users/' + user), {
                                lastDeviceType: currentDeviceType
                            });

                            window.enterDashboard(user, false);
                        } else {
                            alert("â›” ç™»å…¥å¤±æ•—ï¼šæ­¤è£ç½®æœªç¶“æˆæ¬Š (æœªç¶å®š)ã€‚\nè«‹ä½¿ç”¨ã€Œè¨»å†Šä¸¦ç¶å®šã€åŠŸèƒ½è¼¸å…¥é–‹é€šç¢¼ã€‚");
                        }
                    } else {
                        alert("âŒ å¯†ç¢¼éŒ¯èª¤");
                    }
                } else {
                    alert("âŒ å¸³è™Ÿä¸å­˜åœ¨");
                }
            } catch (error) {
                console.error(error);
                alert("ç™»å…¥éŒ¯èª¤");
            }
            showLoading(false);
        });

        document.getElementById('btnAdminLogin').addEventListener('click', () => {
            if (document.getElementById('admin-pass-input').value === ADMIN_PASS) {
                window.enterDashboard("Administrator", true);
            } else {
                alert("å¯†ç¢¼éŒ¯èª¤");
            }
        });

        window.enterDashboard = (user, isAdmin) => {
            document.getElementById('auth-section').style.display = 'none';
            document.getElementById('dashboard-section').style.display = 'flex';
            document.getElementById('display-username').innerText = user;

            if(isAdmin) {
                document.getElementById('admin-link').style.display = 'block';
                window.showAdminPanel(document.getElementById('admin-link').querySelector('a'));
            } else {
                document.getElementById('admin-link').style.display = 'none';
                window.loadPage(0, document.querySelector('.nav-links li a'));
            }
        }

        window.loadPage = (idx, el) => {
            document.getElementById('admin-panel').style.display = 'none';
            document.getElementById('content-frame').style.display = 'block';
            document.getElementById('content-frame').src = SITES[idx];
            if(el) {
                document.querySelectorAll('.nav-links a').forEach(a => a.classList.remove('active'));
                el.classList.add('active');
            }
            if(window.innerWidth <= 768) window.toggleSidebar();
        }

        window.toggleSidebar = () => {
            document.getElementById('sidebar').classList.toggle('active');
            document.querySelector('.sidebar-overlay').classList.toggle('active');
        }

        window.logout = () => {
            localStorage.removeItem('hg_cloud_session');
            location.reload();
        }

        // === ç®¡ç†å¾Œå° (å³æ™‚ç›£è½) ===
        window.showAdminPanel = (el) => {
            document.getElementById('content-frame').style.display = 'none';
            document.getElementById('admin-panel').style.display = 'block';
            if(el) {
                document.querySelectorAll('.nav-links a').forEach(a => a.classList.remove('active'));
                el.classList.add('active');
            }
            
            const usersRef = ref(db, 'users');
            onValue(usersRef, (snapshot) => {
                const tbody = document.getElementById('user-table-body');
                tbody.innerHTML = '';
                if(snapshot.exists()) {
                    snapshot.forEach((childSnapshot) => {
                        const uid = childSnapshot.key;
                        const uData = childSnapshot.val();
                        const deviceCount = uData.authorizedDevices ? uData.authorizedDevices.length : 0;
                        const devLabel = getDeviceLabel(uData.lastDeviceType || 'desktop');
                        
                        tbody.innerHTML += `
                            <tr>
                                <td>${uid}</td>
                                <td>${devLabel}</td>
                                <td>${deviceCount} å°</td>
                                <td><button class="btn btn-danger" style="width:auto; padding:5px; font-size:12px;" onclick="window.deleteCloudUser('${uid}')">åˆªé™¤å¸³è™Ÿ</button></td>
                            </tr>
                        `;
                    });
                } else {
                    tbody.innerHTML = '<tr><td colspan="4">ç›®å‰ç„¡ä½¿ç”¨è€…è³‡æ–™</td></tr>';
                }
            });
        }

        window.deleteCloudUser = async (uid) => {
            if(confirm(`ç¢ºå®šè¦å¾é›²ç«¯åˆªé™¤ä½¿ç”¨è€… ${uid} å—ï¼Ÿ\nè©²ä½¿ç”¨è€…å°‡ç„¡æ³•å†ç™»å…¥ï¼Œæ‰€æœ‰ç¶å®šè£ç½®ä¹Ÿæœƒå¤±æ•ˆã€‚`)) {
                try {
                    await remove(ref(db, 'users/' + uid));
                    alert("å·²åˆªé™¤");
                } catch(e) {
                    alert("åˆªé™¤å¤±æ•—: " + e.message);
                }
            }
        }

        window.generateCode = () => {
            const name = document.getElementById('admin-generate-name').value.trim();
            if(!name) return alert("è«‹è¼¸å…¥å¸³è™Ÿ");
            document.getElementById('generated-code-area').style.display = 'block';
            document.getElementById('display-code').innerText = window.calculateActivationCode(name);
        }

        window.onload = async () => {
            const banDisplay = document.getElementById('banned-list-display');
            if(BANNED_USERS.length > 0) banDisplay.innerHTML = "ç›®å‰å°é–åå–®ï¼š" + BANNED_USERS.join(", ");

            const savedUser = localStorage.getItem('hg_cloud_session');
            if (savedUser) {
                if (BANNED_USERS.includes(savedUser)) {
                    alert("æ‚¨çš„å¸³è™Ÿå·²è¢«åœç”¨");
                    window.logout();
                } else {
                    window.enterDashboard(savedUser, false);
                }
            }
        }
        
        window.toggleSidebar = toggleSidebar;
    </script>
</body>
</html>